policy-options {

  policy-statement underlay-ebgp-ingress {
    term set-default {
      then default-action reject;
    }

  {% for ingress in underlay.policy.ebgp.ingress.iteritems() %}
    term from-route-{{ ingress.name }} {
      from {
      {% for network in ingress.networks.iteritems() %}
        route-filter {{ network }} orlonger;
      {% endfor %}
      }
      then {
        {{ ingress.action }};
      }
    }
  {% endfor %}
  }

  policy-statement underlay-ebgp-egress {
    term set-default {
      then default-action reject;
    }

  {% for egress in underlay.policy.ebgp.egress.iteritems() %}
    term from-route-{{ egress.name }} {
      from {
        protocol direct;
        {% for network in egress.networks.iteritems() %}
          route-filter {{ network }} orlonger;
        {% endfor %}
      }
      then {
        community add {{ egress.community.name }};
        next-hop self;
        {{ egress.action }};
      }
    }

    term from-as-path-{{ egress.community.name }} {
      from {
          as-path asPathLength2;
          community {{ egress.community.name }};
      }
      then {
        reject;
      }
    }
  {% endfor %}
  }

  as-path asPathLength2 ".{2,}";
{% for ingress in underlay.policy.ebgp.ingress.iteritems() %}
  community from-{{ ingress.community.name }} members {{ ingress.community.tag }};
{% endfor%}

}
